<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>八.组件的patch过程 | 伟大的渺小</title>
    <meta name="description" content="Just playing around">
    <meta name="generator" content="VuePress 1.4.0">
    
    
    <link rel="preload" href="/blog/assets/css/0.styles.cf2d1d58.css" as="style"><link rel="preload" href="/blog/assets/js/app.c6873c76.js" as="script"><link rel="preload" href="/blog/assets/js/2.f3dced1f.js" as="script"><link rel="preload" href="/blog/assets/js/16.57a2ba15.js" as="script"><link rel="preload" href="/blog/assets/js/3.0c12c2b7.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.6a588fc0.js"><link rel="prefetch" href="/blog/assets/js/11.b9eb0f01.js"><link rel="prefetch" href="/blog/assets/js/12.69a55ac9.js"><link rel="prefetch" href="/blog/assets/js/13.11adfd75.js"><link rel="prefetch" href="/blog/assets/js/14.f41e1413.js"><link rel="prefetch" href="/blog/assets/js/15.7f50eb8c.js"><link rel="prefetch" href="/blog/assets/js/17.51d435f1.js"><link rel="prefetch" href="/blog/assets/js/18.37e7d0ba.js"><link rel="prefetch" href="/blog/assets/js/19.3a53fa8e.js"><link rel="prefetch" href="/blog/assets/js/20.94462308.js"><link rel="prefetch" href="/blog/assets/js/21.ca951ec7.js"><link rel="prefetch" href="/blog/assets/js/22.d6cd96c9.js"><link rel="prefetch" href="/blog/assets/js/23.fbfe9c0c.js"><link rel="prefetch" href="/blog/assets/js/4.f63d1e71.js"><link rel="prefetch" href="/blog/assets/js/5.39cd2c93.js"><link rel="prefetch" href="/blog/assets/js/6.032ba3c6.js"><link rel="prefetch" href="/blog/assets/js/7.bb87d718.js"><link rel="prefetch" href="/blog/assets/js/8.96303982.js"><link rel="prefetch" href="/blog/assets/js/9.6d9e2089.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.cf2d1d58.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">伟大的渺小</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  HOME
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="VUE" class="dropdown-title"><span class="title">VUE</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/vue/sourcecode/" class="nav-link router-link-active">
  源码分析
</a></li><li class="dropdown-item"><!----> <a href="/blog/vue/vuepress/" class="nav-link">
  vuepress
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="PERSONAL" class="dropdown-title"><span class="title">PERSONAL</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/TyrionJYQ" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/TyrionJ" target="_blank" rel="noopener noreferrer" class="nav-link external">
  csdn
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="/blog/about/" class="nav-link">
  ABOUT
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  HOME
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="VUE" class="dropdown-title"><span class="title">VUE</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/vue/sourcecode/" class="nav-link router-link-active">
  源码分析
</a></li><li class="dropdown-item"><!----> <a href="/blog/vue/vuepress/" class="nav-link">
  vuepress
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="PERSONAL" class="dropdown-title"><span class="title">PERSONAL</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/TyrionJYQ" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/TyrionJ" target="_blank" rel="noopener noreferrer" class="nav-link external">
  csdn
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="/blog/about/" class="nav-link">
  ABOUT
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>源码分析</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/sourcecode/01.html" class="sidebar-link">一.初探vue</a></li><li><a href="/blog/vue/sourcecode/02.html" class="sidebar-link">二.运行时版本和带编译的版本区别</a></li><li><a href="/blog/vue/sourcecode/03.html" class="sidebar-link">三. new Vue背后的故事</a></li><li><a href="/blog/vue/sourcecode/04.html" class="sidebar-link">四.Vue实例的挂载</a></li><li><a href="/blog/vue/sourcecode/05.html" class="sidebar-link">五.虚拟DOM</a></li><li><a href="/blog/vue/sourcecode/06.html" class="sidebar-link">六.虚拟dom成真实的dom</a></li><li><a href="/blog/vue/sourcecode/07.html" class="sidebar-link">七.createComponent方法</a></li><li><a href="/blog/vue/sourcecode/08.html" class="active sidebar-link">八.组件的patch过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/vue/sourcecode/08.html#组件渲染" class="sidebar-link">组件渲染</a></li><li class="sidebar-sub-header"><a href="/blog/vue/sourcecode/08.html#实例分析" class="sidebar-link">实例分析</a></li><li class="sidebar-sub-header"><a href="/blog/vue/sourcecode/08.html#createcomponent" class="sidebar-link">createComponent</a></li><li class="sidebar-sub-header"><a href="/blog/vue/sourcecode/08.html#流程图" class="sidebar-link">流程图</a></li></ul></li><li><a href="/blog/vue/sourcecode/09.html" class="sidebar-link">九. Vue中的options合并</a></li><li><a href="/blog/vue/sourcecode/10.html" class="sidebar-link">十.生命周期</a></li><li><a href="/blog/vue/sourcecode/11.html" class="sidebar-link">十一.组件注册</a></li><li><a href="/blog/vue/sourcecode/" class="sidebar-link">概览</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="组件的patch过程"><a href="#组件的patch过程" class="header-anchor">#</a> 组件的patch过程</h1> <h2 id="组件渲染"><a href="#组件渲染" class="header-anchor">#</a> 组件渲染</h2> <p>从前面的文章分析可以知道<code>Vue.prototype._render</code>函数生成的<code>vnode</code>有两种类型,这是根据传入的<code>options.tag</code>来判断。</p> <ul><li>普通<code>vnode</code> : 也就是<code>typeof tag===string</code></li> <li>组件<code>vnode</code>： <code>options</code>中的<code>tag</code>为对象
在<code>_update</code>方法中传入生成的<code>vnode</code>，进而调用<code>__patch__</code> 方法，在<code>__patch__</code>方法中，又会调用<code>createElm</code>方法将<code>vnode</code>对应的真实<code>dom</code>也就是<code>vnode.elm</code>插入到父节点<code>parentElm</code>上。</li></ul> <blockquote><p>在<code>createElm</code>方法进行插入的过程中会首先调用<code>createComponent</code>方法，组件<code>vnode</code>执行该方法，并返回<code>true</code>,不执行后续逻辑。</p></blockquote> <h2 id="实例分析"><a href="#实例分析" class="header-anchor">#</a> 实例分析</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// index.js</span>
<span class="token keyword">import</span> SubComp <span class="token keyword">from</span> <span class="token string">'@components/SubComp.vue'</span>
<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    el<span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>SubComp<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// subComp.vue</span>
<span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token punctuation">{</span>text<span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script <span class="token operator">&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'subComp'</span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            text<span class="token operator">:</span> <span class="token string">'subComp'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
   
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

<span class="token comment">// index.html</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">&quot;viewport&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta http<span class="token operator">-</span>equiv<span class="token operator">=</span><span class="token string">&quot;X-UA-Compatible&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;ie=edge&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Document<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;app&quot;</span><span class="token operator">&gt;</span>
       
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;./dist/app.bundle.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>

</code></pre></div><p><code>SubComp</code>会被<code>vue-loader</code>编译成<code>tag</code>为一个对象，所以第一次调用<code>render</code>方法生成的<code>vnode</code>为一个组件<code>vnode</code>.</p> <p>在当前<code>new Vue( )</code>生成的实例的<code>_update</code>方法中会将生成的组件<code>vnode</code>作为参数进行调用，执行<code>__patch__</code>方法，<code>__patch__</code> 方法中又会执行<code>createElm</code>方法，这和普通<code>vnode</code>的渲染逻辑一样.不同的是<code>createElm</code>方法。</p> <p>在<code>createElm</code>方法中会首先尝试执行<code>createComponent(vnode)</code>，如果结果为false，就继续执行当前方法<code>createElm</code>中的后续逻辑，但我们的实例中返回的结果为<code>true</code>，所以后续的方法不会执行。</p> <p>下面我们来看看<code>createComponent</code>方法</p> <h2 id="createcomponent"><a href="#createcomponent" class="header-anchor">#</a> <code>createComponent</code></h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
 <span class="token keyword">function</span> <span class="token function">createComponent</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> isReactivated <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i<span class="token punctuation">.</span>keepAlive
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* hydrating */</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// after calling the init hook, if the vnode is a child component</span>
      <span class="token comment">// it should've created a child instance and mounted it. the child</span>
      <span class="token comment">// component also has set the placeholder vnode's elm.</span>
      <span class="token comment">// in that case we can just return the element and be done.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">initComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
        <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>isReactivated<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reactivateComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>记住一点，此时的<code>vnode</code>还是首次调用<code>render</code>方法生成的<code>vnode</code>，<code>createComponent</code>方法主要做了以下几件事</p> <ul><li>根据组件<code>vnode</code>生成组件实例</li> <li>在<code>initComponent</code>方法中进行赋值，<code>vnode.elm = vnode.componentInstance.$el</code>	这里的<code>$el</code>，是组件实例渲染而成的真实<code>dom</code></li> <li>插入<code>insert(parentElm, vnode.elm, refElm)</code>,这里的<code>parentElm</code>也就是<code>body</code></li></ul> <p>经过上面的三步，组件<code>vnode</code>被渲染成真实的<code>dom</code>并插入到<code>body</code>中，但在此之前，<code>vue</code>还做了很多其他的工作。</p> <p>我们知道在生成组件<code>vnode</code>时会添加相应的钩子函数,在<code>src/core/vdom/create-component.js</code>的<code>createComponent</code>方法中执行了<code>installComponentHooks</code> 方法，这个方法是给组件<code>vnode</code>的<code>data</code>中添加相应的钩子函数,因此上面代码中的<code>data.hook.init</code>也就是下面的方法</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
 <span class="token function">init</span> <span class="token punctuation">(</span>vnode<span class="token operator">:</span> VNodeWithData<span class="token punctuation">,</span> hydrating<span class="token operator">:</span> boolean<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">?</span>boolean <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">.</span>_isDestroyed <span class="token operator">&amp;&amp;</span>
      vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>keepAlive
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// kept-alive components, treat as a patch</span>
      <span class="token keyword">const</span> mountedNode<span class="token operator">:</span> any <span class="token operator">=</span> vnode <span class="token comment">// work around flow</span>
      componentVNodeHooks<span class="token punctuation">.</span><span class="token function">prepatch</span><span class="token punctuation">(</span>mountedNode<span class="token punctuation">,</span> mountedNode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> child <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> <span class="token function">createComponentInstanceForVnode</span><span class="token punctuation">(</span>
        vnode<span class="token punctuation">,</span>
        activeInstance
      <span class="token punctuation">)</span>
      child<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span>hydrating <span class="token operator">?</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

</code></pre></div><p>在<code>init</code>方法中会调用<code>createComponentInstanceForVnode</code>方法，会根据<code>vnode</code>生成组件实例（前面的文章已经分析如何生成组件实例，这里不作赘述），并赋值给当前<code>vnode</code>的<code>componentInstance</code>属性.然后手动调用<code>$mount</code>方法</p> <blockquote><p>注意这里的<code>vnode</code>还是首次<code>_render</code> 函数生成的组件<code>vnode</code>
调用<code>$mount</code>方法又会进入组件实例（继承自<code>Vue</code>）的<code>mountComponent方法</code>，然后调用组件实例<code>child</code>的<code>__update</code>,然后<code>__patch__</code>，然后<code>createElm</code>，然后<code>insert</code>，在组件实例对应的<code>insert</code>方法执行完成后，组件<code>SubComp</code>实例的<code>$el</code> 属性是真实的<code>dom</code>，然后赋值给<code>vnode.elm</code>，也就是<code>vnode.elm = vnode.componentInstance.$el</code>，最后执行<code>insert(parentElm, vnode.elm, refElm)</code>。</p></blockquote> <p>经过上面的分析，我们需要了解以下两点</p> <ul><li>每个组件都会生成一个组件实例，组件实例具有<code>Vue</code>的所有属性和方法，因此在手动执行<code>$mount</code>方法后，会执行<code>mountComponent</code>方法，执行<code>_render</code>，执行<code>_update</code>，执行<code>__patch__</code>，执行<code>createElm</code>，执行<code>insert</code>方法，一系列方法执行后，最终完成了子组件的<code>vnode</code>渲染成真实的<code>dom</code>(<code>$el</code>)过程。子组件<code>SubComp</code>的流程跑完后会继续执行后续逻辑<code>insert(parentElm, vnode.elm, refElm)</code>。</li> <li>无论时普通<code>vnode</code>还是组件<code>vnode</code>都是先子后父插入，当前节点的子节点插入到父节点完成后，才会继续当前节点的插入，以确保节点的父子关系。</li></ul> <p><a href="https://github.com/TyrionJYQ/vue-demo-for-learning-source-code" target="_blank" rel="noopener noreferrer">查看demo代码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，请根据当前文章对demo源码中的<code>index.js</code>或者<code>webpack.config.js</code>作相应改动.</p> <h2 id="流程图"><a href="#流程图" class="header-anchor">#</a> 流程图</h2> <p><img src="https://img-blog.csdnimg.cn/20200223225341243.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1R5cmlvbko=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">3/22/2020, 1:02:28 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/vue/sourcecode/07.html" class="prev">
        七.createComponent方法
      </a></span> <span class="next"><a href="/blog/vue/sourcecode/09.html">
        九. Vue中的options合并
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/app.c6873c76.js" defer></script><script src="/blog/assets/js/2.f3dced1f.js" defer></script><script src="/blog/assets/js/16.57a2ba15.js" defer></script><script src="/blog/assets/js/3.0c12c2b7.js" defer></script>
  </body>
</html>
